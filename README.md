# ğŸ“ˆ Quantitative Multi-Factor System

## 1. é¡¹ç›®æ„¿æ™¯ (Project Vision)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª**å·¥ä¸šçº§ã€å…¨æ ˆå¼**çš„é‡åŒ–äº¤æ˜“ç³»ç»Ÿï¼Œæ¶µç›–äº†ä»**å› å­æŒ–æ˜ã€ç¦»çº¿å›æµ‹**åˆ°**å®ç›˜äº¤æ˜“ã€å®æ—¶ç›‘æ§**çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š

1. **çœŸå®æ€§ (Realism)**ï¼šå›æµ‹å¼•æ“ä¸¥æ ¼åŒºåˆ†**ä¿¡å·ä»·æ ¼ (Signal Price)** ä¸ **æ‰§è¡Œä»·æ ¼ (Execution Price)**ï¼Œå¹¶å¼•å…¥ **Gap Risk (è·³ç©ºé£é™©)** æ¨¡æ‹Ÿä¸ **èµ„é‡‘ç¡¬çº¦æŸ**ï¼Œæœç»â€œæœªæ¥å‡½æ•°â€ä¸â€œèµ„é‡‘é€æ”¯â€ã€‚
2. **è§£è€¦ (Decoupling)**ï¼šé‡‡ç”¨ **"Headless Backend + UI Frontend"** æ¶æ„ã€‚äº¤æ˜“æ ¸å¿ƒï¼ˆåå°ï¼‰ä¸ç›‘æ§é¢æ¿ï¼ˆå‰å°ï¼‰é€šè¿‡çŠ¶æ€æ–‡ä»¶å¼‚æ­¥é€šä¿¡ï¼Œäº’ä¸é˜»å¡ã€‚
3. **æ¨¡å—åŒ– (Modularity)**ï¼šç­–ç•¥å·¥å‚æ¨¡å¼ã€é…ç½®åˆ†å±‚ç®¡ç†ã€æ•°æ® ETL åˆ†ç¦»ã€‚

---

## 2. æ ¸å¿ƒç‰¹æ€§ (Key Features)

### ğŸ“Š å›æµ‹å¼•æ“ (Backtest Engine V5)

* **åŒé‡ä»·æ ¼æœºåˆ¶**ï¼šæ¨¡æ‹Ÿ T-1 æ”¶ç›˜å†³ç­–ï¼ˆå®šä»½é¢ï¼‰ï¼ŒT æ—¥å¼€ç›˜æ‰§è¡Œï¼ˆç®—èµ„é‡‘ï¼‰ã€‚
* **èµ„é‡‘é£æ§**ï¼šå†…ç½® **2% ç°é‡‘ç¼“å†² (Cash Buffer)**ï¼Œé˜²æ­¢æ»¡ä»“æ³¢åŠ¨å¯¼è‡´é€æ”¯ã€‚
* **ç¡¬çº¦æŸæ’®åˆ**ï¼šæ‰§è¡Œæ—¶å®æ—¶æ£€æŸ¥ç°é‡‘æµï¼Œè‹¥é‡è·³ç©ºé«˜å¼€å¯¼è‡´èµ„é‡‘ä¸è¶³ï¼Œè‡ªåŠ¨æ‰§è¡Œ **Order Truncation (ç å•)**ã€‚

### ğŸ”´ å®ç›˜æŒ‡æŒ¥èˆ± (Live Cockpit)

* **å‰åç«¯åˆ†ç¦»**ï¼š
* **åå° (Worker)**ï¼š`run_live_strategy.py` è´Ÿè´£è¿æ¥ TWSã€è®¡ç®—ä¿¡å·ã€ä¸‹å•ã€å†™å…¥çŠ¶æ€ã€‚
* **å‰å° (Viewer)**ï¼š`app.py` (Streamlit) è´Ÿè´£è¯»å–çŠ¶æ€ã€å¯è§†åŒ–å±•ç¤º PnLã€å‘é€æŒ‡ä»¤ã€‚


* **IPC é€šä¿¡**ï¼šåŸºäº `dashboard_state.json` å’Œ `command.json` å®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚
* **åº”æ€¥æ§åˆ¶**ï¼šæ”¯æŒ **STOP (æ€¥åœ)**ã€**FLAT (ä¸€é”®æ¸…ä»“)**ã€**CANCEL (æ’¤é”€æŒ‚å•)** ä¸‰å¤§æŒ‡ä»¤ã€‚

### ğŸ­ å·¥ç¨‹åŒ–æ¶æ„

* **ç­–ç•¥å·¥å‚**ï¼š`@register_strategy` è£…é¥°å™¨å®ç°ç­–ç•¥è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹å¼•æ“ä»£ç å³å¯æ‰©å±•ã€‚
* **é…ç½®ä¸­å¿ƒ**ï¼š`base.yaml` (åŸºç¡€) + `backtest/live.yaml` (ç¯å¢ƒ) + `secrets.yaml` (éšç§) çš„å¤šå±‚åˆå¹¶æœºåˆ¶ã€‚
* **DuckDB æ•°æ®ä»“**ï¼šParquet åˆ—å¼å­˜å‚¨ï¼Œç§’çº§åŠ è½½æµ·é‡å› å­æ•°æ®ã€‚

---

## 3. ç³»ç»Ÿæ¶æ„å›¾ (System Architecture)

### ğŸ”„ æ¨¡å¼ A: ç¦»çº¿å›æµ‹ (Backtesting)

```mermaid
graph LR
    Data[DuckDB/Parquet] -->|T-1 Price| Engine[BacktestEngine]
    Data -->|T Price| Engine
    Engine -->|Signal Price| Strat[Strategy]
    Strat -->|Target Weight| Engine
    Engine -->|Execution Price| Port[Portfolio]
    Port -->|Cash Check & Execution| Result[Equity Curve]

```

### ğŸ”´ æ¨¡å¼ B: å®ç›˜ç›‘æ§ (Live Trading)

```mermaid
graph TD
    subgraph "Terminal A (Backend)"
        TWS[IBKR TWS] <-->|ib_insync| Worker[run_live_strategy.py]
        Worker -->|Write State| JSON[dashboard_state.json]
        CMD[command.json] -->|Read Command| Worker
    end

    subgraph "Terminal B (Frontend)"
        JSON -->|Read State| App[app.py / Streamlit]
        User((Trader)) -->|Click Button| App
        App -->|Write Command| CMD
    end

```

---

## 4. æ–‡ä»¶ç»“æ„è¯¦è§£ (File Manifest)

### ğŸ“‚ æ ¹ç›®å½• (Root)

* **`run_backtest.py`**: **[å›æµ‹å…¥å£]**
* **ä½œç”¨**ï¼šå‘½ä»¤è¡Œå›æµ‹å·¥å…·ã€‚åŠ è½½ `backtest.yaml`ï¼Œåˆå§‹åŒ–å¼•æ“ï¼Œè¿è¡Œå›æµ‹å¹¶ä¿å­˜ç»“æœã€‚


* **`run_live_strategy.py`**: **[å®ç›˜åå° - æ— å¤´éª‘å£«]**
* **ä½œç”¨**ï¼š**æ ¸å¿ƒäº¤æ˜“è¿›ç¨‹**ã€‚è´Ÿè´£è¿æ¥ IBã€è®¡ç®—ä¿¡å·ã€æ‰§è¡Œäº¤æ˜“ã€‚å®ƒä¸å« UIï¼Œåªè´Ÿè´£å¹²æ´»å¹¶å°†çŠ¶æ€å†™å…¥ `data/live/`ã€‚åŒ…å«â€œä¿æ´»å¾ªç¯â€ä»¥æŒç»­æ›´æ–° PnLã€‚


* **`app.py`**: **[å…¨èƒ½æ§åˆ¶å°]**
* **ä½œç”¨**ï¼šStreamlit Web åº”ç”¨ã€‚åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š
1. **Strategy Explorer**ï¼šå¯è§†åŒ–å›æµ‹ã€å› å­åˆ†æã€‚
2. **ğŸ”´ Live Dashboard**ï¼šå®ç›˜ç›‘æ§çœ‹æ¿ï¼ˆè¯»å–åå°çŠ¶æ€ã€å‘é€æ§åˆ¶æŒ‡ä»¤ï¼‰ã€‚




* **`run_data_sync.py`**: **[æ•°æ®åŒæ­¥]**
* **ä½œç”¨**ï¼šè¿æ¥ IB ä¸‹è½½å†å²æ•°æ®ï¼Œæ¸…æ´—å¹¶å­˜å…¥ Parquetã€‚


* **`run_factor_computation.py`**: **[å› å­è®¡ç®—]**
* **ä½œç”¨**ï¼šåŸºäºåŸå§‹è¡Œæƒ…è®¡ç®—æŠ€æœ¯å› å­ï¼Œå­˜å…¥ Parquetã€‚



### ğŸ“‚ config (é…ç½®ä¸­å¿ƒ)

* **`__init__.py`**: **[é…ç½®åŠ è½½å™¨]**
* **ä½œç”¨**ï¼šè´Ÿè´£åˆå¹¶ `base` + `env` + `secrets` é…ç½®æ–‡ä»¶çš„é€»è¾‘ã€‚


* **`base.yaml`**: å…¨å±€é€šç”¨é…ç½®ï¼ˆæ•°æ®è·¯å¾„ã€æ ‡çš„æ± è·¯å¾„ï¼‰ã€‚
* **`backtest.yaml`**: å›æµ‹ä¸“ç”¨å‚æ•°ï¼ˆèµ„é‡‘é‡ã€æ‰‹ç»­è´¹ã€èµ·æ­¢æ—¥æœŸï¼‰ã€‚
* **`live.yaml`**: å®ç›˜ä¸“ç”¨å‚æ•°ï¼ˆIB ç«¯å£ã€å®ç›˜é£æ§é˜ˆå€¼ï¼‰ã€‚
* **`secrets.yaml`**: æ•æ„Ÿä¿¡æ¯ï¼ˆé‚®ä»¶æœåŠ¡å™¨å¯†ç ï¼Œ**ä¸ä¸Šä¼  Git**ï¼‰ã€‚

### ğŸ“‚ quant_core (æ ¸å¿ƒä»£ç åº“)

#### ğŸ”¹ `quant_core/backtest_engine.py` (å›æµ‹å¼•æ“)

* **æ ¸å¿ƒé€»è¾‘**ï¼šäº‹ä»¶é©±åŠ¨å¼•æ“ã€‚è´Ÿè´£æ—¶é—´åˆ‡ç‰‡ã€æ•°æ®åŠ è½½ã€ä»¥åŠè°ƒåº¦ Strategy å’Œ Portfolioã€‚
* **å…³é”®ç‚¹**ï¼šå®ç°äº† T-1 ä¿¡å·ä¸ T æ—¥æ‰§è¡Œçš„æ—¶é—´é”™ä½æ¨¡æ‹Ÿã€‚

#### ğŸ”¹ `quant_core/portfolio.py` (è´¦æˆ·è´¦æœ¬)

* **æ ¸å¿ƒé€»è¾‘**ï¼šç®¡ç†ç°é‡‘ã€æŒä»“ã€è®¡ç®—å‡€å€¼ã€‚
* **å…³é”®ç‚¹**ï¼š**æ— çŠ¶æ€è®¾è®¡**ï¼ˆä¸æŒæœ‰å…¨é‡å†å²æ•°æ®ï¼Œåªå¤„ç† Engine ä¼ å…¥çš„å•æ—¥ä»·æ ¼ï¼‰ã€‚å®ç°äº† **2% Cash Buffer** å’Œ **èµ„é‡‘ä¸è¶³è‡ªåŠ¨ç å•**ã€‚

#### ğŸ”¹ `quant_core/strategies/` (ç­–ç•¥å·¥å‚)

* **`base.py`**: ç­–ç•¥åŸºç±»ï¼Œå®šä¹‰æ ‡å‡†æ¥å£ (`on_bar`, `load_data`)ã€‚
* **`rules.py`**: å…·ä½“çš„çº¿æ€§æƒé‡ç­–ç•¥å®ç°ã€‚
* **`__init__.py`**: åŒ…å« `create_strategy_instance` å·¥å‚å‡½æ•°ã€‚

#### ğŸ”¹ `quant_core/live/` (å®ç›˜æ¨¡å—)

* **`trader.py`**: äº¤æ˜“æ‰§è¡Œå™¨ã€‚è´Ÿè´£å°†â€œç›®æ ‡è‚¡æ•°â€è½¬åŒ–ä¸º IB è®¢å•ï¼ŒåŒ…å« **`cancel_all_orders`** é€»è¾‘ã€‚
* **`data_bridge.py`**: æ•°æ®æ¡¥æ¥ã€‚è´Ÿè´£å°† IB å®æ—¶æ•°æ®æ¸…æ´—ä¸ºç­–ç•¥å¯ç”¨çš„ DataFrame æ ¼å¼ã€‚

---

## 5. å¿«é€Ÿå¼€å§‹ (Quick Start)

### åœºæ™¯ä¸€ï¼šè¿è¡Œå›æµ‹ (Backtest)

**æ–¹å¼ Aï¼šå‘½ä»¤è¡Œ**

```bash
python run_backtest.py

```

**æ–¹å¼ Bï¼šWeb UI**

```bash
streamlit run app.py
# åœ¨ä¾§è¾¹æ é€‰æ‹© "Strategy Explorer" -> ç‚¹å‡» "Run Backtest"

```

### åœºæ™¯äºŒï¼šå¯åŠ¨å®ç›˜ç›‘æ§ (Live Trading)

**è¿™æ˜¯åŒè¿›ç¨‹æ¨¡å¼ï¼Œéœ€è¦å¼€å¯ä¸¤ä¸ªç»ˆç«¯çª—å£ã€‚**

#### æ­¥éª¤ 1ï¼šå¯åŠ¨åå°äº¤æ˜“è¿›ç¨‹ (Terminal A)

*è´Ÿè´£è¿æ¥ TWSï¼Œæ‰§è¡Œé€»è¾‘ï¼Œæ°¸ä¸å…³é—­ã€‚*

```bash
source venv/bin/activate
python run_live_strategy.py

```

*çœ‹åˆ° `ğŸ‘ï¸ ...è¿›å…¥å®æ—¶ç›‘æ§æ¨¡å¼` åï¼Œä¿æŒçª—å£å¼€å¯ã€‚*

#### æ­¥éª¤ 2ï¼šå¯åŠ¨å‰å°ç›‘æ§çœ‹æ¿ (Terminal B)

*è´Ÿè´£æ˜¾ç¤º UIï¼Œå¯ä»¥éšæ—¶å…³é—­é‡å¯ã€‚*

```bash
source venv/bin/activate
streamlit run app.py

```

* åœ¨æµè§ˆå™¨ä¸­é€‰æ‹©å·¦ä¾§ **"ğŸ”´ Live Dashboard"**ã€‚
* å¼€å¯ **Auto-Refresh** å¼€å…³ã€‚

---

## 6. å®ç›˜æ“ä½œæŒ‡å— (Live Operations)

åœ¨ **Live Dashboard** ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªç´§æ€¥æŒ‰é’®ï¼š

* **ğŸš« CANCEL (æ’¤å•)**: æ’¤é”€æ‰€æœ‰**å·²æäº¤ä½†æœªæˆäº¤**çš„æŒ‚å• (Open Orders)ã€‚é€‚ç”¨äºä¸‹å•ä»·æ ¼ä¸åˆé€‚æƒ³é‡ä¸‹çš„æƒ…å†µã€‚
* **ğŸ“‰ FLAT (æ¸…ä»“)**: ä»¥**å¸‚ä»· (MKT)** å–å‡ºè´¦æˆ·å†…æ‰€æœ‰æŒä»“ï¼Œå˜ç°ä¸ºç°é‡‘ã€‚é€‚ç”¨äºæç«¯è¡Œæƒ…é¿é™©ã€‚
* **ğŸ›‘ STOP (æ€¥åœ)**: å¼ºåˆ¶ç»ˆæ­¢åå° `run_live_strategy.py` è¿›ç¨‹ã€‚**æ³¨æ„ï¼šè¿™ä¸ä¼šæ’¤å•ä¹Ÿä¸ä¼šå¹³ä»“ï¼Œåªæ˜¯è®©ç¨‹åºåœæ­¢æ€è€ƒã€‚**

---

## 7. å¸¸è§é—®é¢˜ (FAQ)

**Q: ä¸ºä»€ä¹ˆå®ç›˜å¯åŠ¨åå¡åœ¨ "è¿›å…¥å®æ—¶ç›‘æ§æ¨¡å¼..."ï¼Ÿ**
A: è¿™æ˜¯æ­£å¸¸çš„ã€‚åå°è„šæœ¬è¿›å…¥äº† `while True` å¾ªç¯æ¥ç»´æŒå¿ƒè·³å’Œæ›´æ–° PnLã€‚è¯·ä¸è¦å…³é—­å®ƒï¼Œå»å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ `app.py` æŸ¥çœ‹ç•Œé¢ã€‚

**Q: å›æµ‹ä¸ºä»€ä¹ˆæŠ¥é”™ `KeyError: 2018-01-01`ï¼Ÿ**
A: 2018-01-01 æ˜¯å‡æœŸã€‚æœ€æ–°ç‰ˆä»£ç å·²ä¿®å¤æ­¤é—®é¢˜ï¼Œé‡‡ç”¨äº†å¸ƒå°”ç´¢å¼• (`>= start_date`) æ›¿ä»£ç²¾ç¡®ç´¢å¼•å®šä½ã€‚

**Q: `Portfolio` æ˜¯æ€ä¹ˆå¤„ç†è·³ç©ºé«˜å¼€çš„ï¼Ÿ**
A: `Portfolio` åœ¨è®¡ç®—ä¹°å…¥é‡æ—¶ä¼šé¢„ç•™ 2% ç°é‡‘ã€‚å¦‚æœæ¬¡æ—¥å¼€ç›˜ä»·è¿‡é«˜å¯¼è‡´å³ä½¿é¢„ç•™äº†ç°é‡‘ä¹Ÿä¸å¤Ÿï¼Œç³»ç»Ÿä¼šè§¦å‘ **Hard Constraint**ï¼Œè‡ªåŠ¨å‡å°‘ä¹°å…¥è‚¡æ•°ï¼Œç¡®ä¿ç°é‡‘ä¸ä¸ºè´Ÿã€‚