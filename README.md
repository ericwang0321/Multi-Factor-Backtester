# ğŸ“ˆ Quantitative Multi-Factor Backtesting System (my_llm_backtester)

## 1. é¡¹ç›®æ„¿æ™¯ (Project Vision)

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ª**é«˜æ€§èƒ½ã€å·¥ç¨‹åŒ–ã€æ¨¡å—åŒ–**çš„é‡åŒ–å›æµ‹æ¡†æ¶ã€‚æ ¸å¿ƒç›®æ ‡æ˜¯æ”¯æŒå¤šå› å­é€‰è‚¡ç­–ç•¥ï¼ˆMulti-Factor Selectionï¼‰ä¸ ETF è½®åŠ¨ç­–ç•¥çš„å¿«é€ŸéªŒè¯ä¸è¿­ä»£ã€‚

**æ ¸å¿ƒæ¶æ„ç‰¹ç‚¹ï¼š**

* ğŸš€ **ç¦»çº¿é¢„è®¡ç®— (Pre-computation)**ï¼šå½»åº•åˆ†ç¦»â€œå› å­è®¡ç®—â€ä¸â€œç­–ç•¥å›æµ‹â€ã€‚é€šè¿‡ `run_factor_computation.py` å®ç°å› å­çš„å…¨é‡å‘é‡åŒ–è®¡ç®—ä¸æŒä¹…åŒ–å­˜å‚¨ï¼Œå›æµ‹é€Ÿåº¦æå‡ **100x**ã€‚
* ğŸ— **ç­–ç•¥å†…èš (Strategy Cohesion)**ï¼šé‡‡ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼ã€‚ç­–ç•¥ç±» (`BaseStrategy`) è‡ªè¡ŒæŒæœ‰æ•°æ®å¹¶è´Ÿè´£æ‰“åˆ†ï¼Œå›æµ‹å¼•æ“ (`BacktestEngine`) ä»…ä¸“æ³¨äºäº¤æ˜“æ’®åˆã€‚
* ğŸ’¾ **é«˜æ€§èƒ½æ•°æ®å±‚**ï¼šåŸºäº **DuckDB** å’Œ **Parquet** æ„å»ºæœ¬åœ°æ•°æ®ä»“åº“ï¼Œæ”¯æŒæµ·é‡è¡Œæƒ…ä¸å› å­æ•°æ®çš„ç§’çº§æŸ¥è¯¢ã€‚
* ğŸ“Š **å…¨æ ˆå¯è§†åŒ–**ï¼šé›†æˆ Streamlit å‰ç«¯ï¼Œæ”¯æŒå› å­ EDA åˆ†æã€ç­–ç•¥å‚æ•°çƒ­è°ƒä»¥åŠäº¤äº’å¼ç»©æ•ˆå½’å› ã€‚

---

## 2. å½“å‰è¿›åº¦ (Current Status)

**ç›®å‰å¤„äºï¼šé˜¶æ®µ 3.0 - é«˜æ€§èƒ½æ¶æ„é‡æ„å®Œæˆ**

* âœ… **æ•°æ®ä»“åº“**ï¼šDuckDB + Parquet æ¶æ„ï¼Œæ”¯æŒå¢é‡åŒæ­¥ IBKR/å¤–éƒ¨æ•°æ®ã€‚
* âœ… **å› å­å·¥å‚**ï¼šæ–°å¢ `run_factor_computation.py`ï¼Œæ”¯æŒ Xarray å…¨å‘é‡åŒ–è®¡ç®—ï¼Œæ”¯æŒå¢é‡æ›´æ–°ï¼ˆæ™ºèƒ½è·³è¿‡å·²å­˜åœ¨å› å­ï¼‰ã€‚
* âœ… **ç­–ç•¥ä½“ç³»**ï¼šé‡æ„ä¸º `quant_core/strategies/` åŒ…ã€‚å®ç°äº† `LinearWeightedStrategy`ï¼ˆå¤šå› å­çº¿æ€§åŠ æƒ + è‡ªåŠ¨ Z-Scoreï¼‰ã€‚
* âœ… **å›æµ‹å¼•æ“**ï¼šå·²ç˜¦èº«ã€‚ç§»é™¤äº†å†…ç½®è®¡ç®—é€»è¾‘ï¼Œæ”¹ä¸ºçº¯ç²¹çš„äº‹ä»¶é©±åŠ¨æ’®åˆå¼•æ“ã€‚
* âœ… **å‰ç«¯äº¤äº’**ï¼š`app.py` å·²é€‚é…æ–°æ¶æ„ï¼Œæ”¯æŒå†…å­˜çº§å› å­æé€Ÿé¢„è§ˆä¸å›æµ‹ã€‚

---

## 3. ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµ (Architecture & Workflow)

æœ¬æ¡†æ¶é‡‡ç”¨**äº§çº¿åˆ†ç¦»**çš„è®¾è®¡æ€æƒ³ï¼š

```mermaid
graph LR
    A[æ•°æ®æº/IBKR] -->|run_data_sync.py| B(åŸå§‹è¡Œæƒ… Parquet)
    B -->|run_factor_computation.py| C(å› å­æ•°æ® Parquet)
    C -->|Load Offline| D[ç­–ç•¥ Strategy]
    B -->|Load Price| E[å›æµ‹å¼•æ“ BacktestEngine]
    D -->|Signal| E
    E -->|Result| F[ç»©æ•ˆåˆ†æ/Streamlit]

```

1. **æ•°æ®åŒæ­¥**ï¼šè·å– OHLCV æ•°æ®ã€‚
2. **å› å­ç”Ÿäº§**ï¼šæ‰¹é‡è®¡ç®—å› å­ï¼Œå­˜å…¥ `data/processed/factors/`ã€‚
3. **ç­–ç•¥è£…è½½**ï¼šç­–ç•¥è¯»å–ç¦»çº¿å› å­æ–‡ä»¶ã€‚
4. **å›æµ‹æ‰§è¡Œ**ï¼šå¼•æ“æ’®åˆäº¤æ˜“ï¼Œç”Ÿæˆå‡€å€¼æ›²çº¿ã€‚

---

## 4. æ–‡ä»¶ç»“æ„è¯´æ˜ (File Directory)

### ğŸ“‚ æ ¹ç›®å½• (Root)

* **`run_factor_computation.py`**: **[âœ¨ æ ¸å¿ƒç»„ä»¶: å› å­å·¥å‚]**
* **ä½œç”¨**ï¼šè´Ÿè´£â€œå¤‡èœâ€ã€‚è¯»å–å…¨é‡è¡Œæƒ…ï¼Œæ‰¹é‡è®¡ç®—å› å­ï¼ˆå¦‚ RSI, Momentumï¼‰ï¼Œå¹¶ä¿å­˜ä¸º Parquet æ–‡ä»¶ã€‚
* **ç‰¹æ€§**ï¼šæ”¯æŒå¢é‡æ›´æ–°ï¼ˆ`--force` å¼ºåˆ¶é‡ç®—ï¼Œé»˜è®¤è·³è¿‡å·²å­˜åœ¨ï¼‰ã€‚


* **`run_backtest.py`**: **[è„šæœ¬å…¥å£]**
* **ä½œç”¨**ï¼šå‘½ä»¤è¡Œå›æµ‹å…¥å£ã€‚ç›´æ¥è¯»å–ç¡¬ç›˜ä¸Šçš„ç¦»çº¿å› å­æ•°æ®ï¼Œæé€Ÿè¿è¡Œå›æµ‹ã€‚


* **`app.py`**: **[Web å‰ç«¯]**
* **ä½œç”¨**ï¼šStreamlit å¯è§†åŒ–ç•Œé¢ã€‚æ”¯æŒå› å­ EDAã€å‚æ•°è°ƒæ•´ã€å›¾è¡¨ç»˜åˆ¶åŠ Excel æŠ¥å‘Šä¸‹è½½ã€‚


* **`run_data_sync.py`**: **[æ•°æ®åŒæ­¥]**
* **ä½œç”¨**ï¼šè¿æ¥å¤–éƒ¨æ¥å£ä¸‹è½½æœ€æ–°è¡Œæƒ…æ•°æ®ã€‚


* **`config.yaml`**: **[å…¨å±€é…ç½®]**
* **ä½œç”¨**ï¼šé…ç½®å›æµ‹æ—¶é—´ã€èµ„é‡‘ã€è´¹ç‡ä»¥åŠ**å› å­æƒé‡**ã€‚



### ğŸ“‚ quant_core (æ ¸å¿ƒé€»è¾‘åŒ…)

#### ğŸ”¹ `quant_core/strategies/` (ç­–ç•¥åº“ - æ–°æ¶æ„)

* **`base.py`**: **[ç­–ç•¥åŸºç±»]**
* å®šä¹‰æ ‡å‡†æ¥å£ï¼š`load_data()` (æ³¨å…¥æ•°æ®), `on_bar()` (ç”Ÿæˆä¿¡å·), `calculate_weights()` (ç»„åˆæ„å»º)ã€‚


* **`rules.py`**: **[çº¿æ€§ç­–ç•¥å®ç°]**
* **`LinearWeightedStrategy`**ï¼šå®ç°äº†ä¼ ç»Ÿå¤šå› å­é€»è¾‘ã€‚
* **é€»è¾‘**ï¼šè¯»å–å› å­ -> Z-Score æ ‡å‡†åŒ– -> çº¿æ€§åŠ æƒ -> Top N é€‰è‚¡ã€‚



#### ğŸ”¹ `quant_core/factors/` (è®¡ç®—å†…æ ¸)

* **`definitions.py`**: **[å…¬å¼å®šä¹‰]**
* å­˜æ”¾ `RSI`, `Eric_Trend_Score` ç­‰å› å­çš„æ•°å­¦å…¬å¼ï¼ˆåŸºäº Xarray å®ç°å‘é‡åŒ–ï¼‰ã€‚


* **`engine.py`**: **[è®¡ç®—è°ƒåº¦]**
* ä¾› `run_factor_computation.py` è°ƒç”¨ï¼Œè´Ÿè´£å°†åŸå§‹è¡Œæƒ…è½¬åŒ–ä¸ºå› å­å€¼ã€‚



#### ğŸ”¹ `quant_core/data/` (æ•°æ®è®¿é—®)

* **`query_helper.py`**: **[æ•°æ®ç®¡å®¶]**
* å°è£… DuckDB æŸ¥è¯¢ï¼Œç»Ÿä¸€ç®¡ç† Parquet æ–‡ä»¶çš„è¯»å†™ã€‚



#### ğŸ”¹ `quant_core/` (æ‰§è¡Œå±‚)

* **`backtest_engine.py`**: **[æ’®åˆå¼•æ“]**
* **çº¯ç²¹åŒ–**ï¼šä¸å†è®¡ç®—å› å­ã€‚åªè´Ÿè´£å¾ªç¯æ—¥æœŸã€æŸ¥è¯¢ç­–ç•¥ä¿¡å·ã€æ‰§è¡Œä¹°å–ã€æ›´æ–°è´¦æˆ·ã€‚


* **`portfolio.py`**: **[è´¦æˆ·ç®¡ç†]**
* ç®¡ç† Cashã€Positionsã€è®¡ç®—æ¯æ—¥å¸‚å€¼ã€‚


* **`performance.py`**: **[ç»©æ•ˆå½’å› ]**
* è®¡ç®— Alpha, Beta, Sharpe, Drawdown ç­‰æŒ‡æ ‡ã€‚



---

## 5. å¿«é€Ÿå¼€å§‹ (Quick Start)

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡é…ç½®

ä¿®æ”¹ `config.yaml`ï¼Œå®šä¹‰ä½ çš„å¤šå› å­ç»„åˆæƒé‡ï¼š

```yaml
strategy:
  factor_strategy:
    weights:
      momentum: 1.0    # æ­£å‘å› å­
      rsi: -0.5        # åå‘å› å­ (å€¼è¶Šå¤§è¶Šä¸ä¹°)

```

### ç¬¬äºŒæ­¥ï¼šç”Ÿäº§å› å­ (The "Factor Factory")

è¿è¡Œæ­¤è„šæœ¬ç”Ÿæˆå› å­æ•°æ®æ–‡ä»¶ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ä¿®æ”¹å…¬å¼åè¿è¡Œï¼‰ï¼š

```bash
python run_factor_computation.py
# æˆ–è€…å¼ºåˆ¶æ›´æ–°ï¼š python run_factor_computation.py --force

```

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œå›æµ‹

**æ–¹å¼ Aï¼šå‘½ä»¤è¡Œæ¨¡å¼** (é€Ÿåº¦æœ€å¿«)

```bash
python run_backtest.py

```

**æ–¹å¼ Bï¼šWeb äº¤äº’æ¨¡å¼** (å¯è§†åŒ–åˆ†æ)

```bash
streamlit run app.py

```

---

## 6. åç»­è§„åˆ’ (Roadmap)

### ğŸš€ çŸ­æœŸç›®æ ‡ (Short-term)

1. **é£é™©æ¨¡å‹é›†æˆ**ï¼šåœ¨ `BaseStrategy.calculate_weights` ä¸­å¼•å…¥åæ–¹å·®çŸ©é˜µï¼Œæ”¯æŒ **Min-Variance** (æœ€å°æ–¹å·®) æˆ– **Risk Parity** (é£é™©å¹³ä»·) ç»„åˆæ„å»ºã€‚
2. **æ‰©å±•å› å­åº“**ï¼šå°†æ›´å¤šçš„ Alpha101 å’Œ Eric ç³»åˆ—è‡ªå®šä¹‰å› å­å½•å…¥ `definitions.py`ã€‚

### ğŸŒŸ ä¸­æœŸç›®æ ‡ (Mid-term)

1. **æœºå™¨å­¦ä¹ ç­–ç•¥ (ML Strategy)**ï¼š
* æ–°å¢ `quant_core/strategies/ml_strategy.py`ã€‚
* åˆ©ç”¨ `XGBoost` / `LightGBM` æ›¿ä»£ç°æœ‰çš„ `LinearWeightedStrategy` è¿›è¡Œæ‰“åˆ†é¢„æµ‹ã€‚
* å®ç°æ¨¡å‹è®­ç»ƒä¸æ¨ç†çš„åˆ†ç¦»ï¼ˆTraining vs Inferenceï¼‰ã€‚


2. **å®ç›˜å¯¹æ¥**ï¼šåˆ©ç”¨ `ib_insync` å°†ç”Ÿæˆçš„ `Target Positions` è½¬åŒ–ä¸ºçœŸå®çš„ IBKR è®¢å•ã€‚